<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AriesTools — Вход в аккаунт</title>
  <style>
    :root {
      --bg: #0b0f14;
      --bg-elev: #121821;
      --card: #151c26;
      --muted: #8fa0b3;
      --text: #e6edf3;
      --primary: #2ea043;
      --primary-600: #2aa04a;
      --primary-700: #238636;
      --danger: #ff5c5c;
      --border: #263240;
      --input: #10161f;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 800px at 80% -10%, #0f1722 0%, var(--bg) 60%),
                  radial-gradient(1000px 600px at -10% 110%, #0d1320 0%, var(--bg) 60%);
      color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .card {
      width: 100%;
      max-width: 420px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.005)) padding-box,
                  linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.05)) border-box;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 22px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      user-select: none;
    }
    .brand .logo {
      width: 34px; height: 34px;
      border-radius: 8px;
      background: conic-gradient(from 220deg, #38bdf8, #6366f1, #22c55e, #38bdf8);
      box-shadow: 0 8px 24px rgba(56,189,248,.25);
    }
    .brand h1 { font-size: 18px; margin: 0; letter-spacing: .2px; }
    .muted { color: var(--muted); }
    form { margin-top: 12px; }
    .field { margin-bottom: 12px; }
    .label { display:block; margin-bottom:6px; color: var(--muted); font-weight: 600; }
    .input, .btn, .select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      padding: 12px 14px;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease, transform .02s ease;
    }
    .input:focus, .select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, .2);
    }
    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }
    .hint { font-size: 12px; color: var(--muted); margin-top: -2px; margin-bottom: 8px; }
    .btn {
      cursor: pointer;
      background: linear-gradient(180deg, var(--primary-600), var(--primary-700));
      border-color: #1f6f31;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .btn:hover { filter: brightness(1.03); }
    .btn:active { transform: translateY(1px); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .error { display:none; margin: 8px 0; color: #ff9c9c; background: #2a1214; border: 1px solid #511517; padding: 10px 12px; border-radius: 10px; }
    .success { display:none; margin: 8px 0; color: #b9f6ca; background: #0d2a1b; border: 1px solid #17492b; padding: 10px 12px; border-radius: 10px; }
    .code-box {
      display:none;
      margin-top: 12px;
      background: #0f1823;
      border: 1px dashed #2a3a4f;
      border-radius: 12px;
      padding: 12px;
    }
    .code-line { display:flex; gap: 8px; align-items:center; }
    .code { flex:1; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 16px; letter-spacing: 2px; background:#0b1320; padding:10px 12px; border-radius:8px; border:1px solid #253247; text-align:center; }
    .copy-btn { width:auto; padding:10px 14px; border-radius:8px; background:#19283d; border:1px solid #253247; color:#dbe8ff; cursor:pointer; }
    .copy-btn:hover { filter: brightness(1.05); }
    .footer { margin-top: 14px; color: var(--muted); font-size: 12px; text-align: center; }
    @media (max-width: 420px) { .row { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>AriesTools</h1>
      </div>
      <div class="muted">Войдите в аккаунт, чтобы получить код для авторизации скрипта.</div>

      <form id="login-form">
        <div class="field">
          <label class="label" for="login">Логин или Email</label>
          <input class="input" id="login" name="login" autocomplete="username" required placeholder="nickname или email" />
        </div>
        <div class="field">
          <label class="label" for="password">Пароль</label>
          <input class="input" id="password" name="password" type="password" autocomplete="current-password" required placeholder="••••••••" />
        </div>
        <div class="row">
          <div class="field">
            <label class="label" for="server">Сервер</label>
            <select id="server" class="select" name="server">
              <option value="">Авто</option>
              <option value="arizona">Arizona</option>
              <option value="diamond">Diamond</option>
              <option value="advance">Advance</option>
            </select>
          </div>
          <div class="field">
            <label class="label" for="remember">Сессия</label>
            <select id="remember" class="select" name="remember">
              <option value="1">Запомнить</option>
              <option value="0">Не запоминать</option>
            </select>
          </div>
          <div class="field">
            <label class="label" for="ttl">Срок кода</label>
            <select id="ttl" class="select" name="ttl">
              <option value="900">15 минут</option>
              <option value="3600" selected>1 час</option>
              <option value="86400">24 часа</option>
            </select>
          </div>
        </div>

        <div id="error" class="error" role="alert"></div>
        <div id="success" class="success"></div>

        <button id="submit" class="btn" type="submit">Войти и получить код</button>
      </form>

      <div id="codeBox" class="code-box" aria-live="polite">
        <div class="hint">Скопируйте код и вставьте его в скрипт для авторизации.</div>
        <div class="code-line">
          <div id="code" class="code">— — — — — — — —</div>
          <button id="copyBtn" class="copy-btn" type="button">Копировать</button>
        </div>
      </div>

      <div class="code-box" id="editBox" style="display:none; margin-top:12px;">
        <div class="row" style="margin-bottom:10px;">
          <button id="openAccBtn" class="copy-btn" type="button">Открыть/редактировать acc.txt</button>
          <button id="saveAccBtn" class="copy-btn" type="button">Сохранить acc.txt</button>
          <button id="downloadAccBtn" class="copy-btn" type="button" style="display:none;">Скачать обновлённый acc.txt</button>
        </div>
        <div class="hint">Редактор acc.txt (одна запись на строку). Форматы: login | login:password[:server] | login|password|server</div>
        <textarea id="accEditor" style="width:100%; min-height:160px; background:#0b1320; color:#dbe8ff; border:1px solid #253247; border-radius:8px; padding:10px 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; font-size:13px;"></textarea>
      </div>

      <div class="footer">Если у вас нет аккаунта — обратитесь к автору скрипта.</div>
    </div>
  </div>

  <script>

    const form = document.getElementById('login-form');
    const loginEl = document.getElementById('login');
    const passEl = document.getElementById('password');
    const serverEl = document.getElementById('server');
    const rememberEl = document.getElementById('remember');
    const ttlEl = document.getElementById('ttl');
    const btn = document.getElementById('submit');
    const errorEl = document.getElementById('error');
    const successEl = document.getElementById('success');
    const codeBox = document.getElementById('codeBox');
    const codeEl = document.getElementById('code');
     const copyBtn = document.getElementById('copyBtn');
    const editBox = document.getElementById('editBox');
    const accEditor = document.getElementById('accEditor');
    const openAccBtn = document.getElementById('openAccBtn');
    const saveAccBtn = document.getElementById('saveAccBtn');
    const downloadAccBtn = document.getElementById('downloadAccBtn');
     
     // Работа только с локальным acc.txt
     let accounts = [];
    let accTextCache = '';
    let accHandle = null; // FileSystemFileHandle, если пользователь открыл файл через диалог

    function show(el, text) {
      if (text) el.textContent = text;
      el.style.display = 'block';
    }
    function hide(el) { el.style.display = 'none'; }
    function setLoading(state) {
      btn.disabled = state;
      btn.textContent = state ? 'Подождите…' : 'Войти и получить код';
    }

    async function sha256Hex(input) {
      const enc = new TextEncoder();
      const data = enc.encode(input);
      const hash = await crypto.subtle.digest('SHA-256', data);
      const bytes = Array.from(new Uint8Array(hash));
      return bytes.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function formatCode(raw) {
      const upper = (raw || '').replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
      return upper.slice(0, 4) + ' ' + upper.slice(4, 8) + ' ' + upper.slice(8, 12);
    }

    async function fallbackCode(login, password, server) {
      const base = `${login}|${password}|${server||''}|aries-tools`;
      const hex = await sha256Hex(base);
      return (hex.slice(0, 12)).toUpperCase();
    }

    function parseAccTxt(text) {
      // Форматы строк:
      // login
      // login:password[:server]
      // login|password|server
      // Пустые и начинающиеся с # игнорируются
      const list = [];
      text.split(/\r?\n/).forEach(line => {
        const raw = line.trim();
        if (!raw || raw.startsWith('#')) return;
        let parts = raw.split('|');
        if (parts.length === 1) {
          // Может быть формат "login" или "login:..."
          const maybe = raw.split(':');
          parts = maybe.length > 1 ? maybe : parts;
        }
        const [login, password, server] = parts.map(s => (s||'').trim());
        if (login && password) {
          list.push({ login, password, server: server || '', loginOnly: false });
        } else if (login && !password) {
          // Разрешаем строки только с логином — пароль введёт пользователь вручную
          list.push({ login, password: '', server: server || '', loginOnly: true });
        }
      });
      return list;
    }

    async function tryLoadAccTxt() {
      try {
        const resp = await fetch('acc.txt', { cache: 'no-store' });
        if (!resp.ok) throw new Error('not ok');
        const text = await resp.text();
        accTextCache = text;
        accounts = parseAccTxt(text);
        if (accounts.length) {
          const a0 = accounts[0];
          loginEl.value = a0.login;
          passEl.value = a0.password || '';
          if (a0.server) serverEl.value = a0.server;
          hide(errorEl);
          show(successEl, `Загружено аккаунтов: ${accounts.length}`);
        } else {
          show(errorEl, 'acc.txt пуст или имеет неверный формат.');
        }
      } catch (e) {
        // Если браузер блокирует чтение из файла, покажем скрытую кнопку выбора файла
        const pick = document.createElement('input');
        pick.type = 'file';
        pick.accept = '.txt';
        pick.style.display = 'none';
        document.body.appendChild(pick);
        const helper = document.createElement('div');
        helper.className = 'hint';
        helper.textContent = 'Не удалось автоматически прочитать acc.txt. Выберите файл вручную.';
        form.insertBefore(helper, form.firstChild);
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'copy-btn';
        button.textContent = 'Выбрать acc.txt';
        form.insertBefore(button, helper.nextSibling);
        button.addEventListener('click', () => pick.click());
        pick.addEventListener('change', () => {
          const file = pick.files && pick.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            accTextCache = String(reader.result || '');
            accounts = parseAccTxt(accTextCache);
            if (accounts.length) {
              const a0 = accounts[0];
              loginEl.value = a0.login;
              passEl.value = a0.password || '';
              if (a0.server) serverEl.value = a0.server;
              hide(errorEl);
              show(successEl, `Загружено аккаунтов: ${accounts.length}`);
              // Покажем редактор с содержимым
              editBox.style.display = 'block';
              accEditor.value = accTextCache;
            } else {
              show(errorEl, 'acc.txt пуст или имеет неверный формат.');
            }
          };
          reader.onerror = () => show(errorEl, 'Ошибка чтения файла acc.txt.');
          reader.readAsText(file, 'utf-8');
        });
      }
    }

    // Открыть через File System Access API для редактирования
    openAccBtn?.addEventListener('click', async () => {
      if (!window.showOpenFilePicker) {
        show(errorEl, 'Браузер не поддерживает прямое редактирование. Используйте выбор файла при автозагрузке.');
        return;
      }
      try {
        const [handle] = await window.showOpenFilePicker({
          types: [{ description: 'Text', accept: { 'text/plain': ['.txt'] } }]
        });
        accHandle = handle;
        const file = await handle.getFile();
        accTextCache = await file.text();
        accounts = parseAccTxt(accTextCache);
        editBox.style.display = 'block';
        accEditor.value = accTextCache;
        hide(errorEl);
        show(successEl, `Открыт файл acc.txt (${accounts.length} записей).`);
      } catch (e) { /* отменено пользователем */ }
    });

    // Сохранить назад в acc.txt (если есть доступ к файлу)
    saveAccBtn?.addEventListener('click', async () => {
      try {
        const text = accEditor.value;
        if (accHandle && accHandle.createWritable) {
          const writable = await accHandle.createWritable();
          await writable.write(text);
          await writable.close();
          accTextCache = text;
          accounts = parseAccTxt(text);
          show(successEl, 'acc.txt сохранён.');
        } else {
          // Нет прямого доступа — дадим скачать файл
          const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'acc.txt';
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
          show(successEl, 'acc.txt подготовлен к скачиванию.');
        }
      } catch (e) {
        show(errorEl, 'Не удалось сохранить acc.txt.');
      }
    });

    function updateAccWithCode(login, server, code, ttlSec) {
      const expiresAt = new Date(Date.now() + ttlSec * 1000);
      const expIso = expiresAt.toISOString();
      const lines = (accEditor.value || accTextCache || '').split(/\r?\n/);
      let changed = false;
      const updated = lines.map(line => {
        const raw = line.trim();
        if (!raw || raw.startsWith('#')) return line;
        // извлекаем основную часть до комментариев/маркеров
        const base = raw.split('|')[0];
        const base2 = base.split('#')[0];
        const main = base2.trim();
        // получить логин из main
        let lg = main;
        if (main.includes('|')) lg = main.split('|')[0];
        if (main.includes(':')) lg = main.split(':')[0];
        if (lg !== login) return line;
        // сервер в записи (если есть)
        let recServer = '';
        if (main.includes('|')) recServer = (main.split('|')[2]||'').trim();
        if (main.includes(':')) recServer = (main.split(':')[2]||'').trim();
        if (recServer && server && recServer !== server) return line;
        // удалим старые code= и exp=
        const stripped = raw
          .replace(/\s*\|\s*code=[^|#]+/gi, '')
          .replace(/\s*\|\s*exp=[^|#]+/gi, '');
        const result = `${stripped} | code=${code} | exp=${expIso}`.trim();
        changed = true;
        return result;
      });
      if (!changed) {
        // если не нашли запись — добавим новую строку с минимальной формой
        updated.push(`${login}${server? ':' : ''}${server || ''} | code=${code} | exp=${expIso}`.trim());
      }
      const newText = updated.join('\n');
      // показать в редакторе и кэше
      editBox.style.display = 'block';
      accEditor.value = newText;
      accTextCache = newText;
      downloadAccBtn.style.display = accHandle ? 'none' : 'inline-block';
      // если есть доступ к файлу — попробуем автосохранить
      if (accHandle && accHandle.createWritable) {
        saveAccBtn.click();
      } else {
        // предложить скачать
        downloadAccBtn.onclick = () => {
          const blob = new Blob([newText], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'acc.txt';
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
        };
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hide(errorEl); hide(successEl); hide(codeBox);

      const login = loginEl.value.trim();
      const password = passEl.value;
      const server = serverEl.value;
      const remember = rememberEl.value;
      const ttlSec = parseInt(ttlEl.value, 10) || 3600;
      if (!login || !password) {
        show(errorEl, 'Введите логин и пароль.');
        return;
      }

      // Проверяем, что данные есть в acc.txt
      if (!accounts.length) {
        show(errorEl, 'acc.txt не загружен. Положите файл рядом со страницей или выберите его вручную.');
        return;
      }
      // Валидация: если запись содержит только логин, пароль не проверяем
      const found = accounts.some(a => {
        const serverOk = (a.server || '') === (server || '') || !a.server;
        if (!serverOk) return false;
        if (a.loginOnly) return a.login === login; // пароль вводит пользователь
        return a.login === login && a.password === password;
      });
      if (!found) {
        show(errorEl, 'Данные не найдены в acc.txt. Проверьте логин/пароль и сервер.');
        return;
      }

      setLoading(true);
      // Локальная генерация кода без API
      let code = await fallbackCode(login, password, server);
      show(successEl, 'Успешный вход по acc.txt. Код сгенерирован.');

      const formatted = formatCode(code);
      codeEl.textContent = formatted;
      show(codeBox);
      setLoading(false);

      // Обновляем/вписываем код и срок в acc.txt
      try { updateAccWithCode(login, server, code, ttlSec); } catch (_) {}
    });

    copyBtn.addEventListener('click', async () => {
      const txt = codeEl.textContent.replace(/\s+/g, '');
      try {
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = 'Скопировано!';
        setTimeout(() => copyBtn.textContent = 'Копировать', 1400);
      } catch (e) {
        const r = document.createRange();
        r.selectNode(codeEl);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(r);
        document.execCommand('copy');
        sel.removeAllRanges();
      }
    });
    // Автозагрузка acc.txt при открытии страницы
    tryLoadAccTxt();
  </script>
  <!--
     Интеграция со скриптом (acc.txt):
     1) Положите acc.txt рядом с login.html. Форматы строк:
        - login:password
        - login:password:server
        - login|password|server
     2) Откройте страницу, при необходимости выберите файл вручную.
     3) Введите логин/пароль (или используйте префилл), получите код и вставьте в AriesTools.
   -->
</body>
</html>


